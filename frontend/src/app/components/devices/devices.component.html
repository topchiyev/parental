<div class="card mt-3">
  <nav class="navbar navbar-expand-sm navbar-light bg-body-secondary px-3 py-1 rounded-top border-bottom">
    <span class="navbar-brand"><b>Devices</b></span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#devicesActions"
      aria-controls="devicesActions" aria-expanded="false" aria-label="Expand">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="devicesActions">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <button class="nav-link" type="button" (click)="createDevice()">
            <span><b> Create device</b></span>
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <div class="card-body">
    <div class="d-flex flex-wrap">
      <div class="card" style="min-width: 250px;" *ngFor="let device of devices">
        <div class="card-header">
          <div class="d-flex">
            <b class="flex-fill">{{ device.name }}</b>
            <div>
              <button class="btn btn-sm btn-primary" (click)="editDevice(device.id)">Edit</button>
              <button class="btn btn-sm btn-danger ms-1" (click)="deleteDevice(device.id)">Delete</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="d-flex"><b class="me-1">ID:</b> <div class="text-wrap">{{ device.id }}</div></div>
          <div *ngIf="connection?.roleType == UserRoleType.ADMIN" class="d-flex"><b class="me-1">User:</b> <div class="text-wrap">{{ device.username }}</div></div>
          <div class="d-flex"><b class="me-1">Hard Locked:</b> <div class="text-wrap">{{ device.isManuallyLocked ? 'Yes' : 'No' }}</div></div>
          <div class="d-flex"><b class="me-1">Last Handshake:</b> <div class="text-wrap">{{ formatDateTime(device.lastHandshakeOn) }}</div></div>
        </div>
      </div>
      <h4 class="text-info" *ngIf="devices.length == 0">No devices found</h4>
    </div>
  </div>

</div>

<ng-template #deviceEditorTemplate>
  <div class="modal-content" *ngIf="currentDevice">
    <div class="modal-header">
      <h5 class="modal-title">{{ currentDevice.id == '' ? "New Device" : "Device"}}</h5>
    </div>
    <div class="form-group p-3">
      <label class="form-label">ID</label>
      <div class="input-group">
        <input type="text" class="form-control form-control-sm" [(ngModel)]="currentDevice.id" [disabled]="true">
      </div>
    </div>
    <div class="form-group p-3">
      <label class="form-label">Name</label>
      <div class="input-group">
        <input type="text" class="form-control form-control-sm" [(ngModel)]="currentDevice.name">
      </div>
    </div>
    <div class="form-group p-3">
      <label class="form-label">User</label>
      <select class="form-select form-select-sm" [(ngModel)]="currentDevice.username" [disabled]="currentDevice.id != '' && connection?.roleType == UserRoleType.ADMIN">
        <option *ngFor="let item of users" [value]="item.username">
          {{ item.username }}
        </option>
      </select>
    </div>
    <div class="form-group p-3">
      <label class="form-label">Hard Locked</label>
      <div class="input-group">
        <button type="button" class="form-control form-control-sm btn btn-outline-secondary"
          [ngClass]="{'active': currentDevice.isManuallyLocked}"
          (click)="currentDevice.isManuallyLocked = !currentDevice.isManuallyLocked">Yes</button>
        <button type="button" class="form-control form-control-sm btn btn-outline-secondary"
          [ngClass]="{'active': !currentDevice.isManuallyLocked}"
          (click)="currentDevice.isManuallyLocked = !currentDevice.isManuallyLocked">No</button>
      </div>
    </div>
    <div class="modal-header">
      <h5 class="modal-title">Locked Ranges</h5>
    </div>
    <div class="modal-body">
      <table class="table table-stripped">
        <thead>
          <tr>
            <th>
              <div class="d-flex flex-row">
              <div class="flex-fill text-center">From</div>
              <div class="flex-fill text-center">To</div>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let range of currentDevice.lockedRanges">
            <td>
              <div class="d-flex flex-column">
                <div class="d-flex flex-row">
                  <app-time-field class="flex-fill me-1" [(time)]="range.startTime"></app-time-field>
                  <app-time-field class="flex-fill" [(time)]="range.endTime"></app-time-field>
                </div>
                <div class="d-flex flex-row justify-content-end mt-1">
                  <button class="btn btn-sm btn-outline-secondary me-1" (click)="toggleLockedRange(range)"
                    [ngClass]="{'active': range.isEnabled}">{{ range.isEnabled ? 'Disable' : 'Enable' }}</button>
                  <button class="btn btn-sm btn-danger" (click)="deleteLockedRange(range)">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          <tr *ngIf="currentDevice.lockedRanges.length == 0">
            <td colspan="3" class="text-info">No items</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button type="button" (click)="addLockedRange()" class="btn btn-primary">Add Range</button>
      <button type="button" (click)="submitDeviceEditor()" class="btn btn-primary">Save</button>
      <button type="button" (click)="closeDeviceEditor()" class="btn btn-secondary">Close</button>
    </div>
  </div>
</ng-template>
